# Документація Системи Управління Виробництвом (GalaProduction)

Цей документ описує архітектуру, логіку роботи та взаємозв'язки компонентів системи планування виробництва.

**Версія:** 1.0  
**Дата оновлення:** 06.02.2026

---

## 1. Архітектура Системи

Система побудована на трирівневій архітектурі:

1.  **Frontend (Next.js)**: Інтерфейс користувача для перегляду статистики, KPI та формування замовлень.
2.  **API Layer (Next.js Route Handlers)**: Прошарок між клієнтом та базою даних. Виконує роль проксі та валідатора, приховуючи прямі звернення до БД.
3.  **Database (Supabase/PostgreSQL)**: Зберігання даних, складна бізнес-логіка (у Views та RPC функціях).

Структура взаємодії:
`Client (React) <-> API (/api/pizza/...) <-> Supabase (RPC/Views)`

---

## 2. Основні Компоненти (Frontend)

Файл: `src/components/production/ProductionOrderTable.tsx` / `ProductionOpsTable`

Цей компонент є центральним вузлом сторінки планування (`/app/pizza/order-form/page.tsx`).

### Функціонал:
*   **KPI Панель**: Відображає загальні залишки, потребу, цільовий запас та рівень наповнення.
*   **Панель Управління**:
    *   Вибір кількості днів для планування (Input).
    *   **Режим 3х3**: Кнопка швидкого перемикання на 3-денний план (force `days=3`).
    *   Кнопка "Розрахувати".
*   **Таблиця Плану (Drill-down)**:
    *   Відображає згенерований план по днях.
    *   Колонки: `День`, `Назва`, `Прод/день`, `Мін. зал.`, `Факт`, `Замовлення`.
    *   **Інтерактив**: Клік на рядок відкриває деталізацію по магазинах.
*   **Деталізація по Магазинах (Shop Grid)**:
    *   З'являється під таблицею при виборі піци.
    *   Показує картки кожного магазину з червоним індикатором дефіциту (`Факт <= Мін`).

---

## 3. API та Серверна Логіка

Всі ендпоінти знаходяться в `src/app/api/pizza/`.

### 3.1. Генерація Плану
*   **Endpoint**: `/api/pizza/order-plan`
*   **Method**: GET
*   **Параметри**: `?days=N`
*   **Логіка**:
    *   Викликає RPC функцію: `rpc('f_generate_order_plan', { p_days: days })`.
    *   Повертає масив об'єктів плану.

### 3.2. Деталі по Магазинах
*   **Endpoint**: `/api/pizza/shop-stats`
*   **Method**: GET
*   **Параметри**: `?pizza=Name`
*   **Логіка**:
    *   Виконує запит до VIEW: `SELECT * FROM v_pizza_distribution_stats`.
    *   Фільтр: `product_name = pizza`.
    *   Вибірка полів: `spot_name`, `stock_now`, `min_stock`, `avg_sales_day`.

### 3.3. Аналітика (KPI)
*   **Endpoint**: `/api/pizza/analytics`
*   **Method**: GET
*   **Логіка**:
    *   Агрегує дані для верхньої панелі KPI (суми залишків, потреб тощо).

---

## 4. База Даних (PostgreSQL)

Основа логіки винесена на рівень бази даних для швидкодії та цілісності.

### 4.1. Основні Views
*   **`public.v_pizza_distribution_stats`**: Головна аналітична вьюха.
    *   Джерело даних про поточні залишки (`stock_now`) та продажі (`avg_sales_day`).
    *   Використовується для Drill-down деталізації.

### 4.2. RPC Функції (Бізнес-логіка)
*   **`f_generate_order_plan(p_days int)`**:
    1.  Приймає кількість днів планування.
    2.  Розраховує потребу на основі статистики продажів.
    3.  Враховує поточні залишки в цеху та на точках.
    4.  Повертає таблицю:
        *   `plan_day`: Номер дня (1, 2, 3...).
        *   `pizza_name`: Назва продукції.
        *   `daily_avg`: Середні продажі.
        *   `shop_stock`: Поточний залишок.
        *   `min_stock`: Мінімальний поріг.
        *   `production_order`: Розраховане замовлення у виробництво.

### 4.3. Візуальні Індикатори (Умови)
Логіка "червоних" карток на фронтенді базується на порівнянні полів з БД:
*   Якщо `stock_now <= min_stock` -> **CRITICAL** (Червоний фон, червона рамка).

---

## 5. Схема Даних (Data Flow)

1.  **Користувач** обирає "3 дні" та тисне "Розрахувати".
2.  **Frontend** шле GET `/api/pizza/order-plan?days=3`.
3.  **API** викликає `f_generate_order_plan(3)`.
4.  **DB** рахує план та повертає JSON.
5.  **Frontend** малює таблицю.
6.  **Користувач** клікає на "Піца Гавайська".
7.  **Frontend** шле GET `/api/pizza/shop-stats?pizza=Піца Гавайська`.
8.  **API** робить `SELECT ... FROM v_pizza_distribution_stats WHERE product_name = ...`.
9.  **Frontend** відображає картки магазинів, підсвічуючи дефіцит.
